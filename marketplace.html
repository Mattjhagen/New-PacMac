<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K98ZGN2N');</script>
  <!-- End Google Tag Manager -->
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-4D38C33WXN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-4D38C33WXN');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PacMac Marketplace - Local Trading Platform</title>
  <meta name="description" content="Proximity-based marketplace for local trading with escrow protection." />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🛒</text></svg>">
  <script src="config.js" defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg: #000;
      --fg: #eaeaea;
      --muted:#9aa0a6;
      --accent:#6aa7ff;
      --accent-2:#8affd1;
      --success:#10b981;
      --warning:#f59e0b;
      --error:#ef4444;
      --card:#0b0b0b;
      --ring:#1f2937;
      --shadow: 0 10px 25px rgba(0,0,0,.6), 0 2px 6px rgba(0,0,0,.5);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg); background:var(--bg);
      font: 16px/1.45 -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }

    /* Starfield canvas sits behind everything */
    #stars{position:fixed; inset:0; z-index:-1; display:block; background:#000}

    header{
      position:sticky; top:0; backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(0,0,0,.8), rgba(0,0,0,.3));
      border-bottom:1px solid #111; z-index:20;
    }
    .nav{max-width:1200px;margin:0 auto;display:flex;gap:18px;align-items:center; padding:12px 16px}
    .brand{display:flex;gap:10px;align-items:center; font-weight:600; letter-spacing:.2px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 20px var(--accent)}
    .spacer{flex:1}
    .nav a, .nav button.link{color:var(--fg); text-decoration:none; opacity:.9}
    .nav a:hover, .nav button.link:hover{opacity:1}
    .nav .pill{padding:8px 14px; border:1px solid #1a1a1a; border-radius:9999px; background:#0b0b0b}

    .hero{max-width:1200px;margin:40px auto 10px; padding:0 16px; display:grid; gap:18px}
    .hero h1{font-size:clamp(28px, 4vw, 48px); margin:0; letter-spacing:-.02em}
    .hero p{color:var(--muted); margin:0}
    .cta-row{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}

    .main-content{max-width:1200px; margin:0 auto; padding:0 16px}

    /* Marketplace specific styles */
    .marketplace-container {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
      margin: 24px 0;
    }

    .swipe-area {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      min-height: 600px;
      position: relative;
      overflow: hidden;
    }

    .item-card {
      position: absolute;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--card) 0%, #1a1a1a 100%);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      cursor: grab;
      user-select: none;
    }

    .item-card.dragging {
      cursor: grabbing;
      transform: rotate(5deg);
    }

    .item-card.swiped-left {
      transform: translateX(-100%) rotate(-30deg);
      opacity: 0;
    }

    .item-card.swiped-right {
      transform: translateX(100%) rotate(30deg);
      opacity: 0;
    }

    .item-image {
      width: 100%;
      height: 200px;
      background: #1a1a1a;
      border-radius: 12px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: var(--muted);
    }

    .item-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .item-price {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .item-description {
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 16px;
    }

    .item-location {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }

    .swipe-actions {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
    }

    .swipe-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .swipe-btn.dislike {
      background: var(--error);
      color: white;
    }

    .swipe-btn.bid {
      background: var(--accent);
      color: white;
    }

    .swipe-btn.heart {
      background: var(--success);
      color: white;
    }

    .swipe-btn:hover {
      transform: scale(1.1);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }

    .sidebar-card h3 {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 600;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }

    .user-info h4 {
      margin: 0;
      font-size: 16px;
    }

    .user-info p {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .stat-item {
      text-align: center;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 8px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .transaction-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #1a1a1a;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .transaction-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .transaction-status.pending {
      background: var(--warning);
    }

    .transaction-status.disputed {
      background: var(--error);
    }

    .transaction-details h5 {
      margin: 0;
      font-size: 14px;
    }

    .transaction-details p {
      margin: 0;
      color: var(--muted);
      font-size: 12px;
    }

    .countdown-timer {
      background: var(--warning);
      color: #000;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 14px;
      text-align: center;
      margin: 8px 0;
    }

    .chat-bubble {
      background: var(--accent);
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      margin: 4px 0;
      max-width: 80%;
    }

    .chat-bubble.other {
      background: #1a1a1a;
      color: var(--fg);
    }

    .location-input {
      width: 100%;
      padding: 12px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      color: var(--fg);
      margin-bottom: 16px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-secondary {
      background: #1a1a1a;
      color: var(--fg);
      border: 1px solid #333;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal h2 {
      margin: 0 0 16px 0;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .marketplace-container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        order: -1;
      }
    }

    /* OAuth Splash Screen Styles */
    .oauth-splash-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      overflow-y: auto;
    }

    .splash-container {
      max-width: 1200px;
      width: 100%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .splash-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
    }

    .splash-content {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
    }

    .content-wrapper {
      max-width: 1000px;
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 60px;
      align-items: center;
    }

    .welcome-section {
      text-align: left;
    }

    .welcome-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #6aa7ff, #8affd1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin-bottom: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .welcome-title {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 20px;
      color: white;
      line-height: 1.2;
    }

    .gradient-text {
      background: linear-gradient(135deg, #6aa7ff, #8affd1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .welcome-subtitle {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.5;
      margin-bottom: 40px;
    }

    .features-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .feature-item {
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }

    .feature-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .feature-content h3 {
      font-size: 18px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }

    .feature-content p {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.4;
    }

    .auth-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .auth-header h2 {
      font-size: 28px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 10px;
    }

    .auth-header p {
      color: #6b7280;
      margin-bottom: 30px;
    }

    .auth-error {
      margin-bottom: 20px;
      padding: 12px;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      display: none;
    }

    .error-content {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .error-icon {
      color: #dc2626;
    }

    .error-text {
      color: #dc2626;
      font-size: 14px;
    }

    .google-auth-btn {
      width: 100%;
      padding: 16px 20px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .google-auth-btn:hover {
      border-color: #4285f4;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.15);
      transform: translateY(-2px);
    }

    .google-auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .google-icon {
      width: 20px;
      height: 20px;
    }

    .auth-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .x-auth-btn {
      width: 100%;
      padding: 16px 20px;
      background: #1DA1F2;
      border: 2px solid #1DA1F2;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 16px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .x-auth-btn:hover {
      background: #0d8bd9;
      border-color: #0d8bd9;
      box-shadow: 0 4px 12px rgba(29, 161, 242, 0.3);
      transform: translateY(-2px);
    }

    .x-auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .x-icon {
      width: 20px;
      height: 20px;
    }

    .auth-footer {
      margin-bottom: 20px;
      font-size: 12px;
      color: #6b7280;
    }

    .auth-footer a {
      color: #3b82f6;
      text-decoration: none;
    }

    .demo-section {
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .demo-label {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .demo-btn {
      width: 100%;
      padding: 12px 20px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .demo-btn:hover {
      background: #e5e7eb;
      border-color: #9ca3af;
    }

    .splash-footer {
      text-align: center;
      padding: 20px 0;
      color: rgba(255, 255, 255, 0.8);
    }

    .footer-links {
      margin-top: 5px;
      font-size: 14px;
    }

    .footer-links a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
    }

    .footer-links a:hover {
      color: white;
    }

    /* Loading Animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-wrapper {
        grid-template-columns: 1fr;
        gap: 40px;
        text-align: center;
      }

      .welcome-title {
        font-size: 36px;
      }

      .welcome-subtitle {
        font-size: 18px;
      }

      .auth-card {
        padding: 30px 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K98ZGN2N"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <!-- Starfield background -->
  <canvas id="stars"></canvas>

  <!-- OAuth Splash Screen -->
  <div id="oauthSplash" class="oauth-splash-screen">
    <div class="splash-container">
      <!-- Header -->
      <div class="splash-header">
        <div class="logo">
          <div class="logo-icon">📱</div>
          <span>PacMac Marketplace</span>
        </div>
      </div>

      <!-- Main Content -->
      <div class="splash-content">
        <div class="content-wrapper">
          <!-- Welcome Section -->
          <div class="welcome-section">
            <div class="welcome-icon">
              <span>📱</span>
            </div>
            <h1 class="welcome-title">
              Welcome to <span class="gradient-text">PacMac Marketplace</span>
            </h1>
            <p class="welcome-subtitle">
              Your premier destination for buying and selling mobile devices. 
              Sign in with Google to access our full marketplace experience.
            </p>

            <!-- Features Grid -->
            <div class="features-grid">
              <div class="feature-item">
                <div class="feature-icon">✅</div>
                <div class="feature-content">
                  <h3>Verified Sellers</h3>
                  <p>All sellers are authenticated through Google for security and trust</p>
                </div>
              </div>
              
              <div class="feature-item">
                <div class="feature-icon">⭐</div>
                <div class="feature-content">
                  <h3>Quality Guaranteed</h3>
                  <p>Every device is thoroughly tested and comes with our quality promise</p>
                </div>
              </div>
              
              <div class="feature-item">
                <div class="feature-icon">❤️</div>
                <div class="feature-content">
                  <h3>Community Driven</h3>
                  <p>Built by developers, for developers. Open source and transparent</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Authentication Card -->
          <div class="auth-card">
            <div class="auth-header">
              <h2>Get Started</h2>
              <p>Sign in with Google to access the marketplace</p>
            </div>

            <div id="authError" class="auth-error">
              <div class="error-content">
                <span class="error-icon">❌</span>
                <span class="error-text"></span>
              </div>
            </div>

            <div class="auth-buttons">
              <button class="google-auth-btn" onclick="loginWithGoogle()" id="googleAuthBtn">
                <svg class="google-icon" viewBox="0 0 24 24">
                  <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                  <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                  <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                  <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                <span>Continue with Google</span>
              </button>
              
              <!-- X OAuth button temporarily disabled until package is installed -->
              <!--
              <button class="x-auth-btn" onclick="loginWithX()" id="xAuthBtn">
                <svg class="x-icon" viewBox="0 0 24 24" fill="#1DA1F2">
                  <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                </svg>
                <span>Continue with X</span>
              </button>
              -->
            </div>

            <div class="auth-footer">
              <p>By continuing, you agree to our <a href="pacmac_terms_service.html">Terms of Service</a> and <a href="pacmac_privacy_policy.html">Privacy Policy</a></p>
            </div>

            <!-- Demo Mode -->
            <div class="demo-section">
              <p class="demo-label">Or try our demo mode</p>
              <button class="demo-btn" onclick="loginAsDemo()">
                Try Demo Mode
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="splash-footer">
        <p>Built with ❤️ by the PacMac Mobile team</p>
        
        <!-- Product Hunt Badge -->
        <div style="margin: 20px 0;">
          <a href="https://www.producthunt.com/products/pacmac-marketplace?embed=true&utm_source=badge-featured&utm_medium=badge&utm_source=badge-pacmac&#0045;marketplace" target="_blank">
            <img src="https://api.producthunt.com/widgets/embed-image/v1/featured.svg?post_id=1017333&theme=light&t=1758135761627" alt="PacMac&#0032;Marketplace - Local&#0032;trading&#0032;platform | Product Hunt" style="width: 250px; height: 54px;" width="250" height="54" />
          </a>
        </div>
        
        <p class="footer-links">
          <a href="pacmac_privacy_policy.html">Privacy Policy</a>
          {' • '}
          <a href="pacmac_terms_service.html">Terms of Service</a>
          {' • '}
          <a href="https://github.com/Mattjhagen/New-PacMac/raw/refs/heads/main/PacMac_Investor_PitchDeck.pptx" target="_blank">Investor Pitch</a>
          {' • '}
          <a href="https://github.com/Mattjhagen/New-PacMac" target="_blank" rel="noopener noreferrer">View on GitHub</a>
          {' • '}
          <a href="mailto:support@pacmacmobile.com">Contact Support</a>
        </p>
      </div>
    </div>
  </div>

  <!-- Main App (Hidden until authenticated) -->
  <div id="mainApp" class="hidden">
    <header>
      <nav class="nav">
        <div class="brand">
          <div class="dot"></div>
          <span>PacMac Marketplace</span>
        </div>
        <div class="spacer"></div>
        <div id="userMenu" class="user-menu">
          <button class="link" onclick="showProfile()">Profile</button>
          <button class="link" onclick="showTransactions()">Transactions</button>
          <button class="link" onclick="showListings()">My Listings</button>
          <button class="pill" onclick="showAddItem()">+ Add Item</button>
          <button class="link" onclick="logout()">Logout</button>
        </div>
      </nav>
    </header>

  <main class="main-content">
    <div class="hero">
      <h1>Discover Local Treasures</h1>
      <p>Swipe to bid, heart to buy, or pass on items near you</p>
      <div class="cta-row">
        <input type="text" class="location-input" placeholder="Enter your location or ZIP code" id="locationInput">
        <button class="btn btn-primary" onclick="updateLocation()">Update Location</button>
      </div>
    </div>

    <div class="marketplace-container">
      <div class="swipe-area" id="swipeArea">
        <div class="item-card" id="currentItem">
          <div class="item-image" id="itemImage">📱</div>
          <div class="item-title" id="itemTitle">Loading...</div>
          <div class="item-price" id="itemPrice">$0.00</div>
          <div class="item-description" id="itemDescription">Finding items near you...</div>
          <div class="item-location">
            <span>📍</span>
            <span id="itemLocation">Loading location...</span>
          </div>
        </div>
        
        <div class="swipe-actions">
          <button class="swipe-btn dislike" onclick="swipeLeft()" title="Pass (Swipe Left)">
            ❌
          </button>
          <button class="swipe-btn bid" onclick="swipeRight()" title="Bid $0.05 (Swipe Right)">
            💰
          </button>
          <button class="swipe-btn heart" onclick="heartItem()" title="Buy $1.00 (Heart)">
            ❤️
          </button>
        </div>
      </div>

      <div class="sidebar">
        <div class="sidebar-card">
          <h3>Your Profile</h3>
          <div class="user-profile">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
              <h4 id="userName">Guest User</h4>
              <p id="userLocation">Location not set</p>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="totalBids">0</div>
              <div class="stat-label">Total Bids</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalPurchases">0</div>
              <div class="stat-label">Purchases</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="totalSales">0</div>
              <div class="stat-label">Sales</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="rating">5.0</div>
              <div class="stat-label">Rating</div>
            </div>
          </div>
        </div>

        <div class="sidebar-card">
          <h3>Active Transactions</h3>
          <div id="activeTransactions">
            <p style="color: var(--muted); text-align: center;">No active transactions</p>
          </div>
        </div>

        <div class="sidebar-card">
          <h3>Recent Activity</h3>
          <div id="recentActivity">
            <p style="color: var(--muted); text-align: center;">No recent activity</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  </div> <!-- End mainApp -->

  <!-- Modals -->
  <div class="modal hidden" id="addItemModal">
    <div class="modal-content">
      <h2>Add New Item</h2>
      <form id="addItemForm">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">Item Title</label>
          <input type="text" id="itemTitleInput" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">Description</label>
          <textarea id="itemDescriptionInput" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg); height: 100px; resize: vertical;"></textarea>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">Starting Price</label>
          <input type="number" id="itemPriceInput" step="0.01" min="0.05" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">Category</label>
          <select id="itemCategoryInput" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
            <option value="">Select Category</option>
            <option value="electronics">Electronics</option>
            <option value="clothing">Clothing</option>
            <option value="furniture">Furniture</option>
            <option value="books">Books</option>
            <option value="sports">Sports & Recreation</option>
            <option value="tools">Tools</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">Upload Image</label>
          <input type="file" id="itemImageInput" accept="image/*" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="hideAddItem()">Cancel</button>
          <button type="submit" class="btn btn-primary">List Item</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal hidden" id="chatModal">
    <div class="modal-content">
      <h2>Chat with Seller</h2>
      <div id="chatMessages" style="height: 300px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #1a1a1a;">
        <!-- Chat messages will appear here -->
      </div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="chatInput" placeholder="Type your message..." style="flex: 1; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="hideChat()">Close</button>
        <button class="btn btn-primary" onclick="arrangeMeetup()">Arrange Meetup</button>
      </div>
    </div>
  </div>

  <!-- Age Verification Modal -->
  <div class="modal hidden" id="ageVerificationModal">
    <div class="modal-content">
      <h2>Age Verification Required</h2>
      <p>You must be at least 18 years old (21 in some states) to use this platform.</p>
      <form id="ageVerificationForm">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">Birth Date</label>
          <input type="date" id="birthDateInput" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px;">State</label>
          <select id="stateInput" required style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
            <option value="">Select State</option>
            <option value="AL">Alabama (21+)</option>
            <option value="NE">Nebraska (21+)</option>
            <option value="MS">Mississippi (21+)</option>
            <option value="CA">California (18+)</option>
            <option value="NY">New York (18+)</option>
            <option value="TX">Texas (18+)</option>
            <option value="FL">Florida (18+)</option>
            <option value="IL">Illinois (18+)</option>
            <option value="PA">Pennsylvania (18+)</option>
            <option value="OH">Ohio (18+)</option>
            <option value="GA">Georgia (18+)</option>
            <option value="NC">North Carolina (18+)</option>
            <option value="MI">Michigan (18+)</option>
            <option value="NJ">New Jersey (18+)</option>
            <option value="VA">Virginia (18+)</option>
            <option value="WA">Washington (18+)</option>
            <option value="AZ">Arizona (18+)</option>
            <option value="MA">Massachusetts (18+)</option>
            <option value="TN">Tennessee (18+)</option>
            <option value="IN">Indiana (18+)</option>
            <option value="MO">Missouri (18+)</option>
            <option value="MD">Maryland (18+)</option>
            <option value="WI">Wisconsin (18+)</option>
            <option value="CO">Colorado (18+)</option>
            <option value="MN">Minnesota (18+)</option>
            <option value="SC">South Carolina (18+)</option>
            <option value="AL">Alabama (21+)</option>
            <option value="LA">Louisiana (18+)</option>
            <option value="KY">Kentucky (18+)</option>
            <option value="OR">Oregon (18+)</option>
            <option value="OK">Oklahoma (18+)</option>
            <option value="CT">Connecticut (18+)</option>
            <option value="UT">Utah (18+)</option>
            <option value="IA">Iowa (18+)</option>
            <option value="NV">Nevada (18+)</option>
            <option value="AR">Arkansas (18+)</option>
            <option value="NM">New Mexico (18+)</option>
            <option value="WV">West Virginia (18+)</option>
            <option value="ID">Idaho (18+)</option>
            <option value="HI">Hawaii (18+)</option>
            <option value="NH">New Hampshire (18+)</option>
            <option value="ME">Maine (18+)</option>
            <option value="MT">Montana (18+)</option>
            <option value="RI">Rhode Island (18+)</option>
            <option value="DE">Delaware (18+)</option>
            <option value="SD">South Dakota (18+)</option>
            <option value="ND">North Dakota (18+)</option>
            <option value="AK">Alaska (18+)</option>
            <option value="VT">Vermont (18+)</option>
            <option value="WY">Wyoming (18+)</option>
          </select>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="hideAgeVerification()">Cancel</button>
          <button type="submit" class="btn btn-primary">Verify Age</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Identity Verification Modal -->
  <div class="modal hidden" id="identityVerificationModal">
    <div class="modal-content">
      <h2>Identity Verification Required</h2>
      <p>To receive payouts over $50, you must verify your identity with photo ID, address, and last 4 digits of SSN.</p>
      
      <div class="verification-steps">
        <div class="verification-step" id="photoIdStep">
          <h3>1. Photo ID Upload</h3>
          <input type="file" id="photoIdInput" accept="image/*" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg); margin-bottom: 8px;">
          <select id="idTypeInput" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg); margin-bottom: 8px;">
            <option value="">Select ID Type</option>
            <option value="drivers_license">Driver's License</option>
            <option value="passport">Passport</option>
            <option value="state_id">State ID</option>
          </select>
          <input type="text" id="idNumberInput" placeholder="ID Number" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
          <button class="btn btn-primary" onclick="uploadPhotoId()" style="margin-top: 8px;">Upload Photo ID</button>
        </div>

        <div class="verification-step" id="addressStep">
          <h3>2. Address Verification</h3>
          <input type="text" id="addressInput" placeholder="Street Address" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg); margin-bottom: 8px;">
          <input type="text" id="cityInput" placeholder="City" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg); margin-bottom: 8px;">
          <input type="text" id="stateAddressInput" placeholder="State" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg); margin-bottom: 8px;">
          <input type="text" id="zipInput" placeholder="ZIP Code" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
          <button class="btn btn-primary" onclick="verifyAddress()" style="margin-top: 8px;">Verify Address</button>
        </div>

        <div class="verification-step" id="socialStep">
          <h3>3. Social Security Verification</h3>
          <input type="text" id="socialInput" placeholder="Last 4 digits of SSN" maxlength="4" style="width: 100%; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 8px; color: var(--fg);">
          <button class="btn btn-primary" onclick="verifySocial()" style="margin-top: 8px;">Verify SSN</button>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="hideIdentityVerification()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Marketplace Application State
    const MARKETPLACE_STATE = {
      currentUser: null,
      currentItem: null,
      items: [],
      transactions: [],
      chatMessages: [],
      location: null,
      isAuthenticated: false
    };

    // Initialize the marketplace
    async function initMarketplace() {
      console.log('🚀 Initializing PacMac Marketplace...');
      
      // Initialize starfield
      initStarfield();
      
      // Check for OAuth success in URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const authStatus = urlParams.get('auth');
      const authCode = urlParams.get('code');
      
      if (authStatus === 'success') {
        const provider = urlParams.get('provider') || 'google';
        console.log('✅ OAuth authentication successful, provider:', provider);
        
        // Create a temporary authenticated user for OAuth success
        const oauthUser = {
          id: 'oauth-user-' + Date.now(),
          name: provider === 'x' ? 'X User' : 'Google User',
          email: provider === 'x' ? 'user@x.com' : 'user@google.com',
          avatar: provider === 'x' 
            ? 'https://ui-avatars.com/api/?name=X+User&background=1da1f2&color=fff'
            : 'https://ui-avatars.com/api/?name=Google+User&background=3b82f6&color=fff',
          ageVerified: true,
          identityVerified: false,
          totalEarnings: 0,
          isOAuth: true,
          provider: provider
        };
        
        // Store in localStorage to maintain login state
        localStorage.setItem('oauthUser', JSON.stringify(oauthUser));
        MARKETPLACE_STATE.currentUser = oauthUser;
        MARKETPLACE_STATE.isAuthenticated = true;
        
        // Clear URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
        showNotification('Successfully signed in with Google!', 'success');
        
        // Show the main app instead of login screen
        showMainApp();
        updateAuthUI();
        await loadItems();
        showNextItem();
        return; // Skip the normal auth check
      } else if (authStatus === 'error') {
        const errorMessage = urlParams.get('message') || 'Authentication failed';
        console.error('❌ OAuth authentication failed:', errorMessage);
        showNotification('Authentication failed: ' + errorMessage, 'error');
        // Clear URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // Check authentication status
      await checkAuthStatus();
      
      // Set up event listeners
      setupEventListeners();
      
      console.log('✅ Marketplace initialized successfully');
    }

    // Check authentication status
    async function checkAuthStatus() {
      try {
        // Check for OAuth user first
        const oauthUser = localStorage.getItem('oauthUser');
        if (oauthUser) {
          const user = JSON.parse(oauthUser);
          MARKETPLACE_STATE.currentUser = user;
          MARKETPLACE_STATE.isAuthenticated = true;
          showMainApp();
          updateAuthUI();
          await loadItems();
          showNextItem();
          return;
        }
        
        // Check for demo user
        const demoUser = localStorage.getItem('demoUser');
        if (demoUser) {
          const user = JSON.parse(demoUser);
          MARKETPLACE_STATE.currentUser = user;
          MARKETPLACE_STATE.isAuthenticated = true;
          showMainApp();
          updateAuthUI();
          await loadItems();
          showNextItem();
          return;
        }

        const response = await fetch('/auth/user', {
          credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success && data.user) {
          MARKETPLACE_STATE.currentUser = data.user;
          MARKETPLACE_STATE.isAuthenticated = true;
          showMainApp();
          updateAuthUI();
          
          // Load items and show first item
          await loadItems();
          showNextItem();
          
          // Check if age verification is needed
          if (!data.user.ageVerified) {
            showAgeVerification();
          }
          
          // Check if identity verification is needed for payouts
          if (data.user.totalEarnings >= 50 && !data.user.identityVerified) {
            showIdentityVerification();
          }
        } else {
          MARKETPLACE_STATE.isAuthenticated = false;
          showOAuthSplash();
        }
      } catch (error) {
        console.error('Error checking auth status:', error);
        MARKETPLACE_STATE.isAuthenticated = false;
        showOAuthSplash();
      }
    }

    // Show OAuth splash screen
    function showOAuthSplash() {
      document.getElementById('oauthSplash').classList.remove('hidden');
      document.getElementById('mainApp').classList.add('hidden');
    }

    // Show main app
    function showMainApp() {
      document.getElementById('oauthSplash').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
    }

    // Demo login function
    function loginAsDemo() {
      const demoUser = {
        id: 'demo-user',
        name: 'Demo User',
        email: 'demo@pacmacmobile.com',
        avatar: 'https://ui-avatars.com/api/?name=Demo+User&background=3b82f6&color=fff'
      };
      
      MARKETPLACE_STATE.currentUser = demoUser;
      MARKETPLACE_STATE.isAuthenticated = true;
      
      // Store demo user in localStorage
      localStorage.setItem('demoUser', JSON.stringify(demoUser));
      
      showMainApp();
      updateAuthUI();
      loadItems().then(() => showNextItem());
      
      showNotification('Welcome to demo mode! You can explore the marketplace features.', 'success');
    }

    // Update authentication UI
    function updateAuthUI(user = null) {
      const authButtons = document.getElementById('authButtons');
      const userMenu = document.getElementById('userMenu');
      
      // If user is provided, set the authentication state
      if (user) {
        MARKETPLACE_STATE.currentUser = user;
        MARKETPLACE_STATE.isAuthenticated = true;
      }
      
      if (MARKETPLACE_STATE.isAuthenticated) {
        authButtons.classList.add('hidden');
        userMenu.classList.remove('hidden');
        updateUserProfile();
        showMainApp();
      } else {
        authButtons.classList.remove('hidden');
        userMenu.classList.add('hidden');
      }
    }

    // Show login prompt
    function showLoginPrompt() {
      document.getElementById('itemImage').textContent = '🔐';
      document.getElementById('itemTitle').textContent = 'Sign In Required';
      document.getElementById('itemPrice').textContent = 'Get Started';
      document.getElementById('itemDescription').textContent = 'Please sign in with Google to start trading on PacMac Marketplace.';
      document.getElementById('itemLocation').textContent = 'Secure authentication required';
    }

    // Initialize starfield background
    function initStarfield() {
      const canvas = document.getElementById('stars');
      const ctx = canvas.getContext('2d');
      
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      const stars = [];
      const numStars = 100;
      
      for (let i = 0; i < numStars; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 2,
          vx: (Math.random() - 0.5) * 0.5,
          vy: (Math.random() - 0.5) * 0.5
        });
      }
      
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        stars.forEach(star => {
          star.x += star.vx;
          star.y += star.vy;
          
          if (star.x < 0) star.x = canvas.width;
          if (star.x > canvas.width) star.x = 0;
          if (star.y < 0) star.y = canvas.height;
          if (star.y > canvas.height) star.y = 0;
          
          ctx.beginPath();
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fillStyle = '#ffffff';
          ctx.fill();
        });
        
        requestAnimationFrame(animate);
      }
      
      animate();
    }

    // Load user data from localStorage
    function loadUserData() {
      const savedUser = localStorage.getItem('marketplace_user');
      if (savedUser) {
        MARKETPLACE_STATE.currentUser = { ...MARKETPLACE_STATE.currentUser, ...JSON.parse(savedUser) };
      }
      
      updateUserProfile();
    }

    // Save user data to localStorage
    function saveUserData() {
      localStorage.setItem('marketplace_user', JSON.stringify(MARKETPLACE_STATE.currentUser));
    }

    // Update user profile display
    function updateUserProfile() {
      if (!MARKETPLACE_STATE.currentUser) return;
      
      document.getElementById('userName').textContent = MARKETPLACE_STATE.currentUser.name;
      document.getElementById('userLocation').textContent = MARKETPLACE_STATE.currentUser.location || 'Location not set';
      document.getElementById('userAvatar').textContent = MARKETPLACE_STATE.currentUser.name.charAt(0).toUpperCase();
      
      document.getElementById('totalBids').textContent = MARKETPLACE_STATE.currentUser.stats.totalBids;
      document.getElementById('totalPurchases').textContent = MARKETPLACE_STATE.currentUser.stats.totalPurchases;
      document.getElementById('totalSales').textContent = MARKETPLACE_STATE.currentUser.stats.totalSales;
      document.getElementById('rating').textContent = MARKETPLACE_STATE.currentUser.stats.rating.toFixed(1);
    }

    // Load items from API
    async function loadItems() {
      try {
        const response = await fetch('/api/marketplace/items');
        const data = await response.json();
        
        if (data.success) {
          MARKETPLACE_STATE.items = data.items;
          console.log(`📦 Loaded ${data.items.length} items from API`);
        } else {
          console.error('Failed to load items:', data.error);
          loadSampleItems(); // Fallback to sample data
        }
      } catch (error) {
        console.error('Error loading items:', error);
        loadSampleItems(); // Fallback to sample data
      }
    }

    // Load sample items (fallback)
    function loadSampleItems() {
      MARKETPLACE_STATE.items = [
        {
          id: 'item_1',
          title: 'iPhone 13 Pro',
          description: 'Excellent condition, 128GB, space gray. Includes original box and charger.',
          price: 650.00,
          category: 'electronics',
          location: 'Downtown Omaha',
          distance: '2.3 miles',
          image: '📱',
          seller: {
            id: 'seller_1',
            name: 'TechTrader',
            rating: 4.8
          },
          bids: [],
          createdAt: new Date().toISOString()
        },
        {
          id: 'item_2',
          title: 'Vintage Leather Jacket',
          description: 'Classic brown leather jacket, size M. Great condition with minimal wear.',
          price: 85.00,
          category: 'clothing',
          location: 'Midtown',
          distance: '1.8 miles',
          image: '🧥',
          seller: {
            id: 'seller_2',
            name: 'StyleCollector',
            rating: 4.9
          },
          bids: [],
          createdAt: new Date().toISOString()
        }
      ];
    }

    // Show next item in the swipe area
    function showNextItem() {
      if (MARKETPLACE_STATE.items.length === 0) {
        showNoMoreItems();
        return;
      }
      
      // Get random item
      const randomIndex = Math.floor(Math.random() * MARKETPLACE_STATE.items.length);
      MARKETPLACE_STATE.currentItem = MARKETPLACE_STATE.items[randomIndex];
      
      // Update UI
      document.getElementById('itemImage').textContent = MARKETPLACE_STATE.currentItem.image;
      document.getElementById('itemTitle').textContent = MARKETPLACE_STATE.currentItem.title;
      document.getElementById('itemPrice').textContent = `$${MARKETPLACE_STATE.currentItem.price.toFixed(2)}`;
      document.getElementById('itemDescription').textContent = MARKETPLACE_STATE.currentItem.description;
      document.getElementById('itemLocation').textContent = `${MARKETPLACE_STATE.currentItem.location} (${MARKETPLACE_STATE.currentItem.distance})`;
      
      // Reset card position
      const card = document.getElementById('currentItem');
      card.className = 'item-card';
    }

    // Show no more items message
    function showNoMoreItems() {
      document.getElementById('itemImage').textContent = '🎉';
      document.getElementById('itemTitle').textContent = 'No More Items';
      document.getElementById('itemPrice').textContent = 'Check back later!';
      document.getElementById('itemDescription').textContent = 'You\'ve seen all available items in your area. New items are added regularly!';
      document.getElementById('itemLocation').textContent = 'Refresh to see new items';
    }

    // Swipe left (dislike/pass)
    function swipeLeft() {
      const card = document.getElementById('currentItem');
      card.classList.add('swiped-left');
      
      setTimeout(() => {
        // Remove item from list
        if (MARKETPLACE_STATE.currentItem) {
          MARKETPLACE_STATE.items = MARKETPLACE_STATE.items.filter(item => item.id !== MARKETPLACE_STATE.currentItem.id);
        }
        showNextItem();
      }, 300);
    }

    // Swipe right (bid $0.05)
    async function swipeRight() {
      if (!MARKETPLACE_STATE.currentItem) return;
      
      const card = document.getElementById('currentItem');
      card.classList.add('swiped-right');
      
      try {
        // Call API to place bid
        const response = await fetch('/api/marketplace/bid', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            itemId: MARKETPLACE_STATE.currentItem.id,
            bidderId: MARKETPLACE_STATE.currentUser.id,
            bidderName: MARKETPLACE_STATE.currentUser.name,
            amount: 0.05
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Add transaction to local state
          MARKETPLACE_STATE.transactions.push(data.transaction);
          MARKETPLACE_STATE.currentUser.stats.totalBids++;
          
          // Update UI
          updateUserProfile();
          updateTransactionsDisplay();
          saveUserData();
          
          // Show success message with fee breakdown
          const totalFee = 3.00 + (0.05 * 0.03); // $3 + 3% of $0.05
          const totalAmount = 0.05 + totalFee;
          showNotification(`Bid placed! $0.05 + $3.00 fee + $${(0.05 * 0.03).toFixed(2)} (3%) = $${totalAmount.toFixed(2)} total`, 'success');
        } else {
          showNotification('Failed to place bid: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error placing bid:', error);
        showNotification('Failed to place bid. Please try again.', 'error');
      }
      
      setTimeout(() => {
        showNextItem();
      }, 300);
    }

    // Heart item (buy for $1.00)
    async function heartItem() {
      if (!MARKETPLACE_STATE.currentItem) return;
      
      const card = document.getElementById('currentItem');
      card.classList.add('swiped-right');
      
      try {
        // Call API to purchase item
        const response = await fetch('/api/marketplace/purchase', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            itemId: MARKETPLACE_STATE.currentItem.id,
            buyerId: MARKETPLACE_STATE.currentUser.id,
            buyerName: MARKETPLACE_STATE.currentUser.name,
            amount: 1.00
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Add transaction to local state
          MARKETPLACE_STATE.transactions.push(data.transaction);
          MARKETPLACE_STATE.currentUser.stats.totalPurchases++;
          
          // Update UI
          updateUserProfile();
          updateTransactionsDisplay();
          saveUserData();
          
          // Show success message and open chat
          // Show success message with fee breakdown
          const totalFee = 3.00 + (1.00 * 0.03); // $3 + 3% of $1.00
          const totalAmount = 1.00 + totalFee;
          showNotification(`Purchase successful! $1.00 + $3.00 fee + $${(1.00 * 0.03).toFixed(2)} (3%) = $${totalAmount.toFixed(2)} total. Chat and meetup options are now available.`, 'success');
          setTimeout(() => {
            showChat(data.transaction.id);
          }, 1000);
        } else {
          showNotification('Failed to purchase item: ' + data.error, 'error');
        }
      } catch (error) {
        console.error('Error purchasing item:', error);
        showNotification('Failed to purchase item. Please try again.', 'error');
      }
      
      setTimeout(() => {
        showNextItem();
      }, 300);
    }

    // Update location
    function updateLocation() {
      const locationInput = document.getElementById('locationInput');
      const location = locationInput.value.trim();
      
      if (location) {
        MARKETPLACE_STATE.currentUser.location = location;
        MARKETPLACE_STATE.location = location;
        updateUserProfile();
        saveUserData();
        showNotification('Location updated successfully!', 'success');
        
        // Reload items with new location
        loadSampleItems();
        showNextItem();
      }
    }

    // Show add item modal
    function showAddItem() {
      document.getElementById('addItemModal').classList.remove('hidden');
    }

    // Hide add item modal
    function hideAddItem() {
      document.getElementById('addItemModal').classList.add('hidden');
    }

    // Show chat modal
    function showChat(transactionId) {
      document.getElementById('chatModal').classList.remove('hidden');
      // Load chat messages for this transaction
      loadChatMessages(transactionId);
    }

    // Hide chat modal
    function hideChat() {
      document.getElementById('chatModal').classList.add('hidden');
    }

    // Send chat message
    function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      if (message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-bubble';
        messageDiv.textContent = message;
        chatMessages.appendChild(messageDiv);
        
        input.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Add to state
        MARKETPLACE_STATE.chatMessages.push({
          id: 'msg_' + Date.now(),
          transactionId: 'current',
          sender: 'buyer',
          message: message,
          timestamp: new Date().toISOString()
        });
      }
    }

    // Load chat messages
    function loadChatMessages(transactionId) {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      
      // Add welcome message
      const welcomeDiv = document.createElement('div');
      welcomeDiv.className = 'chat-bubble other';
      welcomeDiv.textContent = 'Hello! Thanks for your interest in my item. How can I help you?';
      chatMessages.appendChild(welcomeDiv);
    }

    // Arrange meetup
    function arrangeMeetup() {
      showNotification('Meetup arrangement feature coming soon!', 'info');
    }

    // Update transactions display
    function updateTransactionsDisplay() {
      const container = document.getElementById('activeTransactions');
      const activeTransactions = MARKETPLACE_STATE.transactions.filter(t => t.status === 'pending');
      
      if (activeTransactions.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">No active transactions</p>';
        return;
      }
      
      container.innerHTML = '';
      activeTransactions.forEach(transaction => {
        const div = document.createElement('div');
        div.className = 'transaction-item';
        
        const statusClass = transaction.status === 'pending' ? 'pending' : 'completed';
        const statusText = transaction.status === 'pending' ? 'Pending' : 'Completed';
        
        div.innerHTML = `
          <div class="transaction-status ${statusClass}"></div>
          <div class="transaction-details">
            <h5>${transaction.itemTitle}</h5>
            <p>$${transaction.amount.toFixed(2)} - ${statusText}</p>
            ${transaction.countdownEnd ? `<div class="countdown-timer">24h countdown active</div>` : ''}
          </div>
        `;
        
        container.appendChild(div);
      });
    }

    // Show notification
    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--accent)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1001;
        font-weight: 600;
        box-shadow: var(--shadow);
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Add item form submission
      document.getElementById('addItemForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('itemTitleInput').value;
        const description = document.getElementById('itemDescriptionInput').value;
        const price = parseFloat(document.getElementById('itemPriceInput').value);
        const category = document.getElementById('itemCategoryInput').value;
        
        try {
          // Call API to create item
          const response = await fetch('/api/marketplace/items', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              title: title,
              description: description,
              price: price,
              category: category,
              location: MARKETPLACE_STATE.currentUser.location || 'Unknown',
              sellerId: MARKETPLACE_STATE.currentUser.id,
              sellerName: MARKETPLACE_STATE.currentUser.name
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Add item to local state
            MARKETPLACE_STATE.items.unshift(data.item);
            MARKETPLACE_STATE.currentUser.stats.totalSales++;
            
            // Update UI
            updateUserProfile();
            saveUserData();
            hideAddItem();
            
            // Reset form
            document.getElementById('addItemForm').reset();
            
            showNotification('Item listed successfully!', 'success');
          } else {
            showNotification('Failed to list item: ' + data.error, 'error');
          }
        } catch (error) {
          console.error('Error creating item:', error);
          showNotification('Failed to list item. Please try again.', 'error');
        }
      });
      
      // Chat input enter key
      document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });
      
      // Age verification form submission
      document.getElementById('ageVerificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        verifyAge();
      });
    }

    // Enhanced login with Google function
    async function loginWithGoogle() {
      const authBtn = document.getElementById('googleAuthBtn');
      const authError = document.getElementById('authError');
      
      // Show loading state
      authBtn.disabled = true;
      authBtn.innerHTML = `
        <div style="width: 20px; height: 20px; border: 2px solid #e5e7eb; border-top: 2px solid #4285f4; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span>Authenticating...</span>
      `;
      
      // Hide any previous errors
      authError.style.display = 'none';
      
      try {
        // In demo mode, simulate successful login
        setTimeout(() => {
          try {
            // Simulate successful authentication
            const mockUser = {
              id: 'demo-user-123',
              name: 'Demo User',
              email: 'demo@pacmacmobile.com',
              avatar: null,
              isAdmin: false
            };
            
            // Store user in localStorage for demo
            localStorage.setItem('user', JSON.stringify(mockUser));
            
            // Show success message first
            showAuthError('Demo login successful! Welcome to PacMac Marketplace!', 'success');
            
            // Reset button immediately
            resetAuthButton();
            
            // Update UI to show logged in state after a brief delay
            setTimeout(() => {
              updateAuthUI(mockUser);
            }, 1000);
            
          } catch (innerError) {
            console.error('Demo auth inner error:', innerError);
            showAuthError('Demo authentication failed. Please try again.');
            resetAuthButton();
          }
        }, 1500);
      } catch (error) {
        console.error('Demo auth error:', error);
        showAuthError('Demo authentication failed. Please try again.');
        resetAuthButton();
      }
    }

    // Enhanced login with X function
    async function loginWithX() {
      const authBtn = document.getElementById('xAuthBtn');
      const authError = document.getElementById('authError');
      
      // Show loading state
      authBtn.disabled = true;
      authBtn.innerHTML = `
        <div style="width: 20px; height: 20px; border: 2px solid #e5e7eb; border-top: 2px solid #1DA1F2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span>Authenticating...</span>
      `;
      
      // Hide any previous errors
      authError.style.display = 'none';
      
      try {
        // Redirect to X OAuth
        window.location.href = '/auth/x';
      } catch (error) {
        console.error('X auth error:', error);
        showAuthError('Authentication failed. Please try again.');
        resetXAuthButton();
      }
    }

    // Show authentication error or success message
    function showAuthError(message, type = 'error') {
      const authError = document.getElementById('authError');
      const errorText = authError.querySelector('.error-text');
      errorText.textContent = message;
      
      // Update styling based on message type
      if (type === 'success') {
        authError.className = 'bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg mb-4';
      } else {
        authError.className = 'bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg mb-4';
      }
      
      authError.style.display = 'block';
    }

    // Reset auth button
    function resetAuthButton() {
      const authBtn = document.getElementById('googleAuthBtn');
      authBtn.disabled = false;
      authBtn.innerHTML = `
        <svg class="google-icon" viewBox="0 0 24 24">
          <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
        <span>Continue with Google</span>
      `;
    }

    // Reset X auth button
    function resetXAuthButton() {
      const authBtn = document.getElementById('xAuthBtn');
      authBtn.disabled = false;
      authBtn.innerHTML = `
        <svg class="x-icon" viewBox="0 0 24 24" fill="#1DA1F2">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
        <span>Continue with X</span>
      `;
    }

    function logout() {
      // Clear demo user data if it exists
      localStorage.removeItem('demoUser');
      
      // Clear OAuth user data if it exists
      localStorage.removeItem('oauthUser');
      
      // Clear marketplace state
      MARKETPLACE_STATE.currentUser = null;
      MARKETPLACE_STATE.isAuthenticated = false;
      
      // Show OAuth splash screen
      showOAuthSplash();
      
      // If using Google OAuth, redirect to logout
      if (window.location.pathname.includes('/auth/')) {
        window.location.href = '/auth/logout';
      }
    }

    // Age verification functions
    function showAgeVerification() {
      document.getElementById('ageVerificationModal').classList.remove('hidden');
    }

    function hideAgeVerification() {
      document.getElementById('ageVerificationModal').classList.add('hidden');
    }

    // Identity verification functions
    function showIdentityVerification() {
      document.getElementById('identityVerificationModal').classList.remove('hidden');
    }

    function hideIdentityVerification() {
      document.getElementById('identityVerificationModal').classList.add('hidden');
    }

    // Verification API calls
    async function verifyAge() {
      const birthDate = document.getElementById('birthDateInput').value;
      const state = document.getElementById('stateInput').value;
      
      if (!birthDate || !state) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/verify/age', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ birthDate, state })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Age verification successful!', 'success');
          hideAgeVerification();
          // Refresh user data
          await checkAuthStatus();
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        console.error('Error verifying age:', error);
        showNotification('Failed to verify age. Please try again.', 'error');
      }
    }

    async function uploadPhotoId() {
      const fileInput = document.getElementById('photoIdInput');
      const idType = document.getElementById('idTypeInput').value;
      const idNumber = document.getElementById('idNumberInput').value;
      
      if (!fileInput.files[0] || !idType || !idNumber) {
        showNotification('Please fill in all fields', 'error');
        return;
      }
      
      // Convert file to base64
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const response = await fetch('/api/verify/photo-id', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({
              imageData: e.target.result,
              idType: idType,
              idNumber: idNumber
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            showNotification('Photo ID uploaded successfully!', 'success');
          } else {
            showNotification(data.error, 'error');
          }
        } catch (error) {
          console.error('Error uploading photo ID:', error);
          showNotification('Failed to upload photo ID. Please try again.', 'error');
        }
      };
      reader.readAsDataURL(file);
    }

    async function verifyAddress() {
      const address = document.getElementById('addressInput').value;
      const city = document.getElementById('cityInput').value;
      const state = document.getElementById('stateAddressInput').value;
      const zipCode = document.getElementById('zipInput').value;
      
      if (!address || !city || !state || !zipCode) {
        showNotification('Please fill in all address fields', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/verify/address', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ address, city, state, zipCode })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Address verification successful!', 'success');
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        console.error('Error verifying address:', error);
        showNotification('Failed to verify address. Please try again.', 'error');
      }
    }

    async function verifySocial() {
      const lastFour = document.getElementById('socialInput').value;
      
      if (!lastFour || lastFour.length !== 4) {
        showNotification('Please enter the last 4 digits of your SSN', 'error');
        return;
      }
      
      try {
        const response = await fetch('/api/verify/social', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ lastFour })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showNotification('Social Security verification successful!', 'success');
          // Refresh user data
          await checkAuthStatus();
        } else {
          showNotification(data.error, 'error');
        }
      } catch (error) {
        console.error('Error verifying social security:', error);
        showNotification('Failed to verify social security. Please try again.', 'error');
      }
    }

    // Placeholder functions for future implementation
    function showProfile() {
      showNotification('Profile management coming soon!', 'info');
    }

    function showTransactions() {
      showNotification('Transaction history coming soon!', 'info');
    }

    function showListings() {
      showNotification('My listings management coming soon!', 'info');
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initMarketplace);
  </script>
</body>
</html>
